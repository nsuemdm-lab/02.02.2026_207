# 04.02.2026
**Группа:** 9-ИС207
**Дата:** 04 февраля 2026 г. (понедельник)
**Формат:** **Очный** (Студенты работают в классе, подключение к Beget/Github).

---

### ОБЩАЯ КОНЦЕПЦИЯ ДНЯ: «ОТ КАРТИНКИ К ДЕЙСТВИЮ»
**Статус:** На прошлом занятии (22.01) создана витрина (Read) и админка для наполнения (Create).

**Проблема:** Сайт «мертвый». Пользователи могут смотреть, но не могут взаимодействовать (купить, заказать, забронировать).
**Задача дня:** Реализовать бизнес-логику взаимодействия (оформление заказа/заявки) и связать таблицы базы данных (Связь «Многие-ко-Многим» или «Один-ко-Многим»).

---

#### 13:20 | ПАРА №1. ПМ.09. Проектирование и разработка
**Тема:** Реализация бизнес-логики (Обработка действий пользователя).
**Формат:** Практическое руководство (Remote Guide).

**ВВЕДЕНИЕ ДЛЯ СТУДЕНТОВ:**
> Сегодня работаем удаленно. На прошлом уроке мы сделали "Витрину". Сегодня мы должны заставить кнопку "Купить" (или "Записаться", "Скачать") работать. Мы создадим таблицу заказов и свяжем пользователя с товаром.

**ИНСТРУКЦИЯ**

**ШАГ 1. Проектирование таблицы действий (SQL)**
В зависимости от вашей темы, создайте таблицу в phpMyAdmin (вкладка SQL). Это связующее звено между `users` и вашей основной таблицей (`products`/`books`).

*Шаблон SQL (измените под себя):*
```sql
CREATE TABLE `orders` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL COMMENT 'Кто заказал',
  `product_id` INT NOT NULL COMMENT 'Что заказал',
  `status` ENUM('new', 'processing', 'done') DEFAULT 'new',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  -- Внешние ключи для целостности (опционально для новичков, но полезно)
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),
  FOREIGN KEY (`product_id`) REFERENCES `products`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```
*Адаптация:*
*   **Библиотека:** Таблица `loans` (выдачи книг). Поля: `user_id`, `book_id`, `return_date`.
*   **HelpDesk:** Вы уже создали `tickets` на прошлом уроке. Вам нужно убедиться, что там есть поле `user_id`.

**ШАГ 2. Скрипт обработки заказа (Logic)**
Создайте файл `make_order.php`. Он не будет иметь верстки, он только обрабатывает нажатие кнопки.

```php
<?php
session_start();
require 'db.php';

// 1. Проверка: Вошел ли пользователь?
if (!isset($_SESSION['user_id'])) {
    die("Сначала войдите в систему! <a href='login.php'>Вход</a>");
}

// 2. Получаем ID товара из ссылки (например, make_order.php?id=5)
// (int) — это защита от хакеров, превращаем всё в число
$product_id = (int)$_GET['id'];
$user_id = $_SESSION['user_id'];

if ($product_id > 0) {
    // 3. Создаем заказ
    $stmt = $pdo->prepare("INSERT INTO orders (user_id, product_id) VALUES (?, ?)");
    try {
        $stmt->execute([$user_id, $product_id]);
        echo "Заказ успешно оформлен! Менеджер свяжется с вами. <a href='index.php'>Вернуться</a>";
    } catch (PDOException $e) {
        echo "Ошибка: " . $e->getMessage();
    }
} else {
    echo "Неверный товар.";
}
?>
```

**ШАГ 3. Подключение кнопки**
В файле `index.php` найдите кнопку "Купить" (или аналог) и сделайте её ссылкой:
```html
<!-- Было -->
<a href="#" class="btn btn-primary">Купить</a>

<!-- Стало -->
<a href="make_order.php?id=<?= $product['id'] ?>" class="btn btn-primary">Купить</a>
```

**ЗАДАНИЕ НА ПАРУ:** Реализовать сохранение заявки/заказа в БД. Убедиться, что в phpMyAdmin появляются новые строки в таблице `orders`.

---

#### 15:05 | ПАРА №2. ПМ.09. Оптимизация веб-приложений
**Тема:** Агрегация данных. Работа с JOIN запросами.
**Цель:** Администратор должен видеть не просто ID товаров, а понятный список заказов (Кто заказал? Что заказал?).

**ВВЕДЕНИЕ**
> Если вы сейчас посмотрите в таблицу `orders`, вы увидите только числа: `user_id=5`, `product_id=12`. Это непонятно. Нам нужно "подтянуть" имена клиентов и названия товаров. Для этого мы используем SQL команду `JOIN`.

**ИНСТРУКЦИЯ:**

**ШАГ 1. Создание страницы управления заказами**
Создайте файл `admin_orders.php`.
Вставьте защиту (как на прошлом уроке):
```php
<?php
require 'check_admin.php'; // Только админ!
require 'db.php';

// САМОЕ СЛОЖНОЕ: Объединяем 3 таблицы в одном запросе
// orders (главная) + users (чтобы взять email) + products (чтобы взять название)
$sql = "
    SELECT 
        orders.id as order_id,
        orders.created_at,
        users.email,
        products.title,
        products.price
    FROM orders
    JOIN users ON orders.user_id = users.id
    JOIN products ON orders.product_id = products.id
    ORDER BY orders.id DESC
";

$stmt = $pdo->query($sql);
$orders = $stmt->fetchAll();
?>
```

**ШАГ 2. Визуализация таблицы**
Далее в этом же файле добавьте HTML:
```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Управление заказами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <h1>Все заказы</h1>
    <a href="index.php">На главную</a>
    
    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>ID Заказа</th>
                <th>Дата</th>
                <th>Клиент (Email)</th>
                <th>Товар</th>
                <th>Цена</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($orders as $order): ?>
            <tr>
                <td><?= $order['order_id'] ?></td>
                <td><?= $order['created_at'] ?></td>
                <td><?= htmlspecialchars($order['email']) ?></td>
                <td><?= htmlspecialchars($order['title']) ?></td>
                <td><?= $order['price'] ?> ₽</td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</body>
</html>
```

**ЗАДАНИЕ НА ПАРУ:** Адаптировать запрос `JOIN` под свою тему.
*   *Подсказка:* Если у вас тема "Техподдержка", вы объединяете `tickets` и `users`.
*   *Подсказка:* Если у вас "Блог", вы объединяете `comments`, `users` и `posts`.

---

#### 16:50 | ПАРА №3. МДК.09.03. Обеспечение безопасности
**Тема:** Валидация входных данных и защита логики (IDOR/SQLi).
**Контекст:** Дистанционная работа требует самопроверки.

**ТЕОРИЯ (Кратко в чат):**
> «Мы научились передавать данные через адресную строку: `make_order.php?id=10`.
> Хакер может изменить это на `?id=99999` (несуществующий товар) или `?id=text` (попытка сломать SQL).
> Сегодня мы учимся "Жесткой типизации" и проверкам "на дурака".»

**ПРАКТИКУМ «DEFENSIVE CODING» (Защитное программирование):**

**Задание А. Приведение типов (Casting)**
Вернитесь в файл `make_order.php`.
Посмотрите на строку: `$product_id = $_GET['id'];`
Это уязвимость. Если передать массив или строку, база может выдать ошибку.
Исправьте на:
```php
$product_id = (int)$_GET['id']; // Превращаем ВСЁ в число. "text" станет 0.
```

**Задание Б. Проверка существования (Logic check)**
Перед тем как сохранить заказ, мы должны проверить, а существует ли такой товар?
Модифицируйте код `make_order.php`:

```php
// ... получение ID ...

// ПРОВЕРКА БЕЗОПАСНОСТИ №2: А есть ли такой товар?
$check = $pdo->prepare("SELECT id FROM products WHERE id = ?");
$check->execute([$product_id]);
$exists = $check->fetch();

if (!$exists) {
    die("Ошибка: Попытка заказать несуществующий товар! Ваш IP записан.");
}

// ... только теперь делаем INSERT в orders ...
```

**Задание В. (Для продвинутых/на "отлично") Защита от накрутки**
Добавьте проверку: пользователь не может заказывать один и тот же товар чаще, чем раз в 5 минут (используйте поле `created_at` последнего заказа этого юзера).

---

### ИТОГОВЫЙ РЕЗУЛЬТАТ ДНЯ (CHECKLIST)
К концу дистанционного дня у студента должно быть:
1.  **Рабочая кнопка действия:** Пользователь нажимает — в БД появляется запись.
2.  **Связи в БД:** Таблица `orders` (или аналог) ссылается на `users` и `products`.
3.  **Админка менеджера:** Таблица, собранная через `INNER JOIN`, показывающая понятные данные (Email, Название), а не просто ID.
4.  **Код проверен:** Везде используется `(int)$_GET` для защиты от мусорных данных.
5.  **Ссылка с кодом на GitHub:** в контрольном опросе отправьте ссылку на публичный репозитарий. В конце 3-й пары скинуть скриншот страницы admin_orders.php с 2-3 тестовыми заказами. Это подтвердит выполнение всех этапов (БД настроена, логика работает, админка выводит данные).
